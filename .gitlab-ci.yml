stages:
    - fmt
    - compile
    - unit test
    - build examples
    - release

# ----------------------------------------------------------------------
# 1. ç¼“å­˜é…ç½® (Cache Configuration)
# ----------------------------------------------------------------------
cache:
    policy: pull-push

# ----------------------------------------------------------------------
# 2. rustfmt æ£€æŸ¥
# ----------------------------------------------------------------------
rust-fmt-check:
    stage: fmt
    image: rust-compiler:1.0
    script:
        - rustup component add rustfmt
        - cargo fmt -- --check

# ----------------------------------------------------------------------
# 3. æ™®é€šç¼–è¯‘æ£€æŸ¥
# ----------------------------------------------------------------------
rust-compile-check:
    stage: compile
    image: rust-compiler:1.0
    script:
        - cargo check --all-targets --all-features

# ----------------------------------------------------------------------
# 4. å•å…ƒæµ‹è¯•
# ----------------------------------------------------------------------
rust-unit-test:
    stage: unit test
    image: rust-compiler:1.0
    script:
        - cargo test --all-targets --verbose

# ----------------------------------------------------------------------
# 5. æ„å»ºç¤ºä¾‹ç¨‹åº
# ----------------------------------------------------------------------
build-example:
    stage: build examples
    image: rust-compiler:1.0
    script:
        # å®‰è£…eframeä¾èµ–
        - cargo add eframe --dev
        # æ„å»ºç¤ºä¾‹ç¨‹åº
        - cargo build --example demo --release
        # ä¸ºç¤ºä¾‹ç¨‹åºåˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶å
        - cp target/release/examples/demo target/release/egui_sgr_demo
    artifacts:
        paths:
            - target/release/egui_sgr_demo
        expire_in: 1 week
        name: "egui_sgr_demo_${CI_COMMIT_SHORT_SHA}"

# ----------------------------------------------------------------------
# 6. æ„å»ºå‘å¸ƒç‰ˆæœ¬ï¼ˆLinux MUSLï¼‰
# ----------------------------------------------------------------------
build-linux-musl:
    stage: release
    image: rust-compiler:1.0
    rules:
        - if: $CI_COMMIT_TAG # åªæœ‰åœ¨æ¨é€æ ‡ç­¾æ—¶æ‰§è¡Œ
    before_script:
        - rustup target add x86_64-unknown-linux-musl
        - apt-get update && apt-get install -y musl-tools
    script:
        # å®‰è£…eframeä¾èµ–
        - cargo add eframe --dev
        # æ„å»ºç¤ºä¾‹ç¨‹åºï¼ˆé™æ€é“¾æ¥ï¼‰
        - cargo build --example demo --release --target x86_64-unknown-linux-musl
        # ä¸ºç¤ºä¾‹ç¨‹åºåˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶å
        - cp target/x86_64-unknown-linux-musl/release/examples/demo target/release/egui_sgr_demo_linux
    artifacts:
        paths:
            - target/release/egui_sgr_demo_linux
        expire_in: 1 week
        name: "egui_sgr_demo_linux_${CI_COMMIT_TAG}"

# ----------------------------------------------------------------------
# 7. æ„å»ºå‘å¸ƒç‰ˆæœ¬ï¼ˆWindowsï¼‰
# ----------------------------------------------------------------------
build-windows:
    stage: release
    image: rust-compiler:1.0
    rules:
        - if: $CI_COMMIT_TAG # åªæœ‰åœ¨æ¨é€æ ‡ç­¾æ—¶æ‰§è¡Œ
    before_script:
        - rustup target add x86_64-pc-windows-gnu
        - apt-get update && apt-get install -y mingw-w64
    script:
        # å®‰è£…eframeä¾èµ–
        - cargo add eframe --dev
        # æ„å»ºç¤ºä¾‹ç¨‹åºï¼ˆWindowsï¼‰
        - cargo build --example demo --release --target x86_64-pc-windows-gnu
        # ä¸ºç¤ºä¾‹ç¨‹åºåˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶å
        - cp target/x86_64-pc-windows-gnu/release/examples/demo.exe target/release/egui_sgr_demo_windows.exe
    artifacts:
        paths:
            - target/release/egui_sgr_demo_windows.exe
        expire_in: 1 week
        name: "egui_sgr_demo_windows_${CI_COMMIT_TAG}"

# ----------------------------------------------------------------------
# 8. åˆ›å»º GitLab Release é¡µé¢
# ----------------------------------------------------------------------
create-gitlab-release:
    stage: release
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    needs:
        - build-linux-musl
        - build-windows
    rules:
        - if: $CI_COMMIT_TAG
    script:
        - echo "Creating GitLab Release for $CI_COMMIT_TAG"
    release:
        name: "Release $CI_COMMIT_TAG"
        tag_name: "$CI_COMMIT_TAG"
        description: |
            ## ğŸ‰ æ­£å¼å‘å¸ƒ egui_sgr $CI_COMMIT_TAG

            æœ¬æ¬¡ Release åŒ…å«ï¼š

            - **egui_sgr** åº“ï¼šä¸€ä¸ªå°†ANSIè½¬ä¹‰åºåˆ—é¢œè‰²æ¨¡å‹è½¬æ¢ä¸ºeguiæ–‡æœ¬é¢œè‰²çš„Ruståº“
            - **æ¼”ç¤ºç¨‹åº**ï¼šå±•ç¤ºåº“çš„åŠŸèƒ½å’Œç”¨æ³•

            ### åŠŸèƒ½ç‰¹æ€§
            - æ”¯æŒ4ä½è‰²ï¼ˆ16è‰²ï¼‰æ¨¡å‹
            - æ”¯æŒ8ä½è‰²ï¼ˆ256è‰²ï¼‰æ¨¡å‹
            - æ”¯æŒ24ä½çœŸå½©è‰²æ¨¡å‹
            - è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢æ··åˆé¢œè‰²åºåˆ—
            - æ”¯æŒå‰æ™¯è‰²å’ŒèƒŒæ™¯è‰²åŒæ—¶è®¾ç½®
            - æ™ºèƒ½ç¼“å­˜å’Œåº”ç”¨å½“å‰é¢œè‰²çŠ¶æ€

            ### ä½¿ç”¨ç¤ºä¾‹
            ```rust
            use egui_sgr::ansi_to_rich_text;

            // 4ä½è‰²ï¼ˆ16è‰²ï¼‰
            let red_text = ansi_to_rich_text("\x1b[31mçº¢è‰²æ–‡æœ¬\x1b[0m");

            // 8ä½è‰²ï¼ˆ256è‰²ï¼‰
            let orange_text = ansi_to_rich_text("\x1b[38;5;208mæ©™è‰²æ–‡æœ¬\x1b[0m");

            // 24ä½çœŸå½©è‰²
            let pink_text = ansi_to_rich_text("\x1b[38;2;255;105;180mç²‰è‰²æ–‡æœ¬\x1b[0m");
            ```
        assets:
            links:
                - name: "Linux æ¼”ç¤ºç¨‹åº (x86_64-unknown-linux-musl)"
                  url: "$CI_SERVER_URL/$CI_PROJECT_PATH/-/jobs/artifacts/$CI_COMMIT_TAG/raw/target/release/egui_sgr_demo_linux?job=build-linux-musl"
                  link_type: "other"
                - name: "Windows æ¼”ç¤ºç¨‹åº (x86_64-pc-windows-gnu)"
                  url: "$CI_SERVER_URL/$CI_PROJECT_PATH/-/jobs/artifacts/$CI_COMMIT_TAG/raw/target/release/egui_sgr_demo_windows.exe?job=build-windows"
                  link_type: "other"
                - name: "æºä»£ç "
                  url: "$CI_PROJECT_URL"
                  link_type: "other"
